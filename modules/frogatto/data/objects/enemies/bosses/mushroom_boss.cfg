{
id: "mushroom_boss",
prototype: ["standard_values"],
always_active: true,
/*editor_info: {
	category: "boss",
},*/

properties: {
	max_shots: "if(higher_difficulty, 8, 3)",
	should_shoot: "(filter(level.chars, value.type = 'mushroom_boss.big_shot').size <= max_shots)",

	begin_chargeup: "execute(me, [animation('chargeup')])",
	begin_idle: "execute(me, [animation('normal')])",
	begin_attack: "execute(me, [if(should_shoot,animation('attack'),begin_idle)])",
	set_behavior: "def(choice) execute(me, [switch(choice,
					'chargeup', begin_chargeup,
					'attack', [begin_idle, schedule(1d100,begin_attack)],
		),debug(should_shoot)])",
},


on_create: "",


on_process: "((([set(custom_draw,
		[0.0,1.0,
		1.2,1.4,1.5,1.7,
		2.0,3.0,
		3.3,3.5,3.6,3.8,
		[upper_left[0]*scl(0.7),upper_left[1]*scl(0.7)],[upper_right[0]*scl(0.7),upper_right[1]*scl(0.7)],
		[upper_right[0]*scl(1.1),upper_right[1]], [upper_right[0]*scl(0.4),upper_right[1]], [upper_right[0]*scl(0.1),upper_right[1]],still,
		still,still,
		still,[upper_left[0]*scl(0.1),upper_left[1]], [upper_left[0]*scl(0.4),upper_left[1]], [upper_left[0]*scl(1.1),upper_left[1]],
		])]
		
		) where scl = def(factor) sin(factor*90)
		where upper_left = [offset_x,offset_y]
		where upper_right = [offset_x,offset_y2]
		where still = [0,0]
		
		)
		
		where offset_x = (sin(cycle*5)*150)*0.06
		where offset_y = (sin(    cycle*3)*80)*0.04 + y_bob
		where offset_y2 = -(sin(40+ cycle*3)*80)*0.04 + y_bob
		
		) where y_bob = sin(cycle*10)*5
		
		 ",
		
on_end_normal_anim:  "[set(facing,-facing),animation('normal')]",
on_end_attack_anim:  "begin_idle",
on_end_chargeup_anim:  "[animation('chargeup')]",

on_shoot: "spawn(type+'.big_shot', mid_x, y, 1, set(velocity_y, -500 - 1d400))",

animation: [
{
	"@base": true,
	image: "enemies/mushroom-boss1.png",
	palettes: "@include data/palettes.cfg:forest_palettes",
	feet_x: 80,
},
{
	id: "normal",
	rect: [0,0,159,159],
	frames:3,
	reverse: yes,
	duration: 3,
	feet_y: 160,
},
{
	id: "chargeup",
	image: "enemies/mushroom-boss2.png",
	rect: [0,0,159,175],
	frames:3,
	reverse: yes,
	duration: 3,
	feet_y: 176,
},
{
	id: "attack",
	image: "enemies/mushroom-boss3.png",
	rect: [0,0,159,175],
	frames:2,
	reverse: yes,
	duration: 6,
	feet_y: 176,
	events: "6:shoot",
}
],

object_type: [ {
		id: "controller",
		always_active: true,
		
		timer_frequency: 150,
		on_timer: "pick_random_behavior",
		
		
		properties: {
			stalks: "filter(level.chars, value.type = 'mushroom_boss')",
			pick_random_behavior: "map(stalks, value.set_behavior(choice) where choice = if(randVal = index, 'chargeup', 'attack')) where randVal = 1d4",
			
		},
		
		animation: {
			id: "normal",
			image: "enemies/mushroom-boss1.png",
			rect: [0,0,1,1],
		},
		
	},
	{
		id: "big_shot",
		always_active: true,
		prototype: ["shot"],
		traction_in_air: 1000,
		friction: 2000,
		on_collide_level: "null",
		zorder: "@include data/zorders.cfg:in_front_of_parallax_objects",
		
		on_create: "[schedule(200+1d350,die()), add_particles('smoke')] ",
		on_end_anim: "animation('normal')",
		on_die: "spawn('mushroom_boss.ammo', mid_x, mid_y, facing,[set(child.vars.time_spat,level.cycle),set(child.animation, 'on_back')])",
		
		properties: {
			accel_towards_player: "[set(accel_x, if(level.player.mid_x > mid_x, 20, -20)),set(accel_y, if(level.player.mid_y > mid_y, 20, -20))]",
			adjust_size: "set(scale, 1.0 - 0.001 * cycle)",
		},

		on_process: "[accel_towards_player, adjust_size]",

		animation: [
		{
			id: "normal",
			image: "enemies/mushroom-boss-shots.png",
			rect: [0,0,31,31],
			duration: 10,
		},
		{
			id: "normal",
			image: "enemies/mushroom-boss-shots.png",
			rect: [0,0,31,31],
			duration: 2,
			frames: 10,
		},
		],
		particle_system: {
			id: "smoke",
			type: "simple",
			spawn_rate: 500,
			time_to_live: 50,
			min_x: -10,
			max_x: 42,
			min_y: -10,
			max_y: 42,
			velocity_x: -200,
			velocity_y: -200,
			velocity_x_random: 400,
			velocity_y_random: 400,
		
			#color=255,255,255,255
			#delta_a: 8,
			animation: {
				id: "sparkle",
				image: "enemies/mushroom-boss-shots.png",
				x: 0,
				y: 48,
				w: 16,
				h: 16,
				pad: 0,
				frames: 6,
				duration: 4,
			},
		},
	},
	{
		id: "ammo",
		prototype: ["throwable_projectile"],
		properties: {
			is_player_ammo: 1,
		},
		animation: [
		{
			"@base": true,
			image: "enemies/mushroom-boss-shots.png",
			rect: [0,32,15,47],
			accel_y: 80,
			frames: 1,
			duration: 10,
		},
		{
			id: "normal",
			body_area: "all",
		},
		{
			id: "thrown",
			body_area: null,
			thrown_area: "all",
		},
		{
			id: "on_back",
			body_area: "all",
			thrown_area: null,
		}],
	}],

}